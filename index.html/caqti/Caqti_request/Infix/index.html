<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Infix (caqti.Caqti_request.Infix)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../../index.html">caqti</a> &#x00BB; <a href="../index.html">Caqti_request</a> &#x00BB; Infix</nav><header class="odoc-preamble"><h1>Module <code><span>Caqti_request.Infix</span></code></h1><p>The following operators provides a more visually appealing way of expressing requests. They are implemented in terms of <a href="../index.html#val-create"><code>create</code></a> and <a href="../../Caqti_query/index.html#val-of_string_exn"><code>Caqti_query.of_string_exn</code></a>, meaning the the query string arguments accepts <a href="../../query_template.html" title="query_template">The Syntax of Query Templates</a>.</p><p>The <code>?oneshot</code> argument defaults to <code>false</code>, so when not constructing one-shot queries, the full application <code>(pt --&gt;! rt) f</code> can be written <code>pt --&gt;! rt @@ f</code>, which motivates the <a href="#val-(@:-)"><code>(@:-)</code></a> and <a href="#val-(@@:-)"><code>(@@:-)</code></a> shortcuts.</p><p>In the simplest case you can use this module directly together with <a href="../../Caqti_type/index.html"><code>Caqti_type</code></a>:</p><pre class="language-ocaml"><code>let bounds_upto_req =
  let open Caqti_type.Std in
  let open Caqti_request.Infix in
  tup2 int32 float --&gt;! option (tup2 float float) @:-
  &quot;SELECT min(y), max(y) FROM samples WHERE series_id = ? AND x &lt; ?&quot;</code></pre><p>For more complex applications it may be convenient to provide a custom module, to avoid the double open and to customize the operators, e.g.</p><pre class="language-ocaml"><code>module Caqtireq = struct
  include Caqti_type.Std
  include Caqti_type_calendar (* if needed, link caqti-type-calendar *)
  include Caqti_request.Infix

  (* Any additional types. *)
  let password = redacted string
  let uri =
    custom ~encode:(fun x -&gt; Ok (Uri.to_string x))
           ~decode:(fun s -&gt; Ok (Uri.of_string s)) string

  (* Optionally define a custom environment providing two schema names.
   * The references should only be assigned at startup. *)
  let myapp_schema = ref &quot;myapp&quot;
  let mylib_schema = ref &quot;mylib&quot;
  let env = function
   | &quot;&quot; -&gt; Caqti_query.L !myapp_schema
   | &quot;mylib&quot; -&gt; Caqti_query.L !mylib_schema
   | _ -&gt; raise Not_found

  (* Since we have a custom environment, override the definitions of the
   * following operators to perform the substitution. *)
  let (@:-) t qs =
    let q = Caqti_query.expand env (Caqti_query.of_string_exn qs) in
    t (fun _ -&gt; q)
  let (@@:-) t qsf =
    t (fun driver_info -&gt;
      let qs = qsf (Caqti_driver_info.dialect_tag driver_info) in
      Caqti_query.expand env (Caqti_query.of_string_exn qs))
end</code></pre><p>If you don't like using global references, or you need to work with different enviroments for different connections, you should instead pass the environment function when connecting to the database. We can now simplify and schema-qualify the previous request,</p><pre class="language-ocaml"><code>let bounds_upto_req =
  let open Caqtireq in
  tup2 int32 float --&gt;! option (tup2 float float) @:-
  &quot;SELECT min(y), max(y) FROM $.samples WHERE series_id = ? AND x &lt; ?&quot;</code></pre><p><a href="#indep" title="indep">Constructors for Driver-Independent Requests</a> also provides alternative arrow operators for this common case, which allows using short-from local open,</p><pre class="language-ocaml"><code>let bounds_upto_req =
  Caqtireq.(tup2 int32 float -&gt;! option (tup2 float float))
  &quot;SELECT min(y), max(y) FROM $.samples WHERE series_id = ? AND x &lt; ?&quot;</code></pre></header><nav class="odoc-toc"><ul><li><a href="#indep">Constructors for Driver-Independent Requests</a></li><li><a href="#constructors-for-driver-dependent-requests">Constructors for Driver-Dependent Requests</a></li></ul></nav><div class="odoc-content"><h3 id="indep"><a href="#indep" class="anchor"></a>Constructors for Driver-Independent Requests</h3><div class="odoc-spec"><div class="spec value anchored" id="val-(-&gt;.)"><a href="#val-(-&gt;.)" class="anchor"></a><code><span><span class="keyword">val</span> (-&gt;.) : 
  <span><span><span class="type-var">'a</span> <a href="../../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?oneshot</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'a</span>, unit, <span>[ `Zero ]</span>)</span> <a href="../index.html#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>(pt -&gt;. Caqti_type.unit) ?oneshot s</code> is the request which sends the query string <code>s</code>, encodes parameters according to <code>pt</code>, and expects no result rows. See <a href="../index.html#val-create"><code>create</code></a> for the meaning of <code>oneshot</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-(-&gt;!)"><a href="#val-(-&gt;!)" class="anchor"></a><code><span><span class="keyword">val</span> (-&gt;!) : 
  <span><span><span class="type-var">'a</span> <a href="../../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'b</span> <a href="../../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?oneshot</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span>[ `One ]</span>)</span> <a href="../index.html#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>(pt -&gt;! rt) ?oneshot s</code> is the request which sends the query string <code>s</code>, encodes parameters according to <code>pt</code>, and decodes a single result row according to <code>rt</code>. See <a href="../index.html#val-create"><code>create</code></a> for the meaning of <code>oneshot</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-(-&gt;?)"><a href="#val-(-&gt;?)" class="anchor"></a><code><span><span class="keyword">val</span> (-&gt;?) : 
  <span><span><span class="type-var">'a</span> <a href="../../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'b</span> <a href="../../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?oneshot</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span>[ `Zero <span>| `One</span> ]</span>)</span> <a href="../index.html#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>(pt -&gt;? rt) ?oneshot s</code> is the request which sends the query string <code>s</code>, encodes parameters according to <code>pt</code>, and decodes zero or one result row according to <code>rt</code>. See <a href="../index.html#val-create"><code>create</code></a> for the meaning of <code>oneshot</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-(-&gt;*)"><a href="#val-(-&gt;*)" class="anchor"></a><code><span><span class="keyword">val</span> (-&gt;*) : 
  <span><span><span class="type-var">'a</span> <a href="../../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'b</span> <a href="../../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?oneshot</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span>[ `Zero <span>| `One</span> <span>| `Many</span> ]</span>)</span> <a href="../index.html#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>(pt -&gt;* rt) ?oneshot s</code> is the request which sends the query string <code>s</code>, encodes parameters according to <code>pt</code>, and decodes any number of result rows according to <code>rt</code>. See <a href="../index.html#val-create"><code>create</code></a> for the meaning of <code>oneshot</code>.</p></div></div><h3 id="constructors-for-driver-dependent-requests"><a href="#constructors-for-driver-dependent-requests" class="anchor"></a>Constructors for Driver-Dependent Requests</h3><p>The below arrow operators takes a function instead of a string as their third argument. The function receives information about the current driver and returns a <a href="../../Caqti_query/index.html#type-t"><code>Caqti_query.t</code></a>. This is the most general way of providing the query string.</p><p>As an alternative to using plain application (or <code>@@</code>) for the third positional argument, additional application operators are provided for convenience.</p><div class="odoc-spec"><div class="spec value anchored" id="val-(--&gt;.)"><a href="#val-(--&gt;.)" class="anchor"></a><code><span><span class="keyword">val</span> (--&gt;.) : 
  <span><span><span class="type-var">'a</span> <a href="../../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>unit <a href="../../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?oneshot</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="../../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../Caqti_query/index.html#type-t">Caqti_query.t</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'a</span>, unit, <span>[ `Zero ]</span>)</span> <a href="../index.html#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>(pt --&gt;. Caqti_type.unit) ?oneshot f</code> is the request which sends the query string returned by <code>f</code>, encodes parameters according to <code>pt</code>, and expects no result rows. See <a href="../index.html#val-create"><code>create</code></a> for the meaning of <code>oneshot</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-(--&gt;!)"><a href="#val-(--&gt;!)" class="anchor"></a><code><span><span class="keyword">val</span> (--&gt;!) : 
  <span><span><span class="type-var">'a</span> <a href="../../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'b</span> <a href="../../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?oneshot</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="../../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../Caqti_query/index.html#type-t">Caqti_query.t</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span>[ `One ]</span>)</span> <a href="../index.html#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>(pt --&gt;! rt) ?oneshot f</code> is the request which sends the query string returned by <code>f</code>, encodes parameters according to <code>pt</code>, and decodes a single result row according to <code>rt</code>. See <a href="../index.html#val-create"><code>create</code></a> for the meaning of <code>oneshot</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-(--&gt;?)"><a href="#val-(--&gt;?)" class="anchor"></a><code><span><span class="keyword">val</span> (--&gt;?) : 
  <span><span><span class="type-var">'a</span> <a href="../../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'b</span> <a href="../../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?oneshot</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="../../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../Caqti_query/index.html#type-t">Caqti_query.t</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span>[ `Zero <span>| `One</span> ]</span>)</span> <a href="../index.html#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>(pt --&gt;? rt) ?oneshot f</code> is the request which sends the query string returned by <code>f</code>, encodes parameters according to <code>pt</code>, and decodes zero or one result row according to <code>rt</code>. See <a href="../index.html#val-create"><code>create</code></a> for the meaning of <code>oneshot</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-(--&gt;*)"><a href="#val-(--&gt;*)" class="anchor"></a><code><span><span class="keyword">val</span> (--&gt;*) : 
  <span><span><span class="type-var">'a</span> <a href="../../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">'b</span> <a href="../../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?oneshot</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="../../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../Caqti_query/index.html#type-t">Caqti_query.t</a>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span>[ `Zero <span>| `One</span> <span>| `Many</span> ]</span>)</span> <a href="../index.html#type-t">t</a></span></span></code></div><div class="spec-doc"><p><code>(pt --&gt;* rt) ?oneshot f</code> is the request which sends the query string returned by <code>f</code>, encodes parameters according to <code>pt</code>, and decodes any number of result rows according to <code>rt</code>. See <a href="../index.html#val-create"><code>create</code></a> for the meaning of <code>oneshot</code>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-(@:-)"><a href="#val-(@:-)" class="anchor"></a><code><span><span class="keyword">val</span> (@:-) : 
  <span><span>(<span><span>(<span><a href="../../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../Caqti_query/index.html#type-t">Caqti_query.t</a>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'m</span>)</span> <a href="../index.html#type-t">t</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span>string <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'m</span>)</span> <a href="../index.html#type-t">t</a></span></span></code></div><div class="spec-doc"><p>Applies a dialect-independent query string which is parsed with <a href="../../Caqti_query/index.html#val-of_string_exn"><code>Caqti_query.of_string_exn</code></a>. Composition with arrow operators from this section, gives the corresponding operators from <a href="#indep" title="indep">Constructors for Driver-Independent Requests</a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-(@@:-)"><a href="#val-(@@:-)" class="anchor"></a><code><span><span class="keyword">val</span> (@@:-) : 
  <span><span>(<span><span>(<span><a href="../../Caqti_driver_info/index.html#type-t">Caqti_driver_info.t</a> <span class="arrow">&#45;&gt;</span></span> <a href="../../Caqti_query/index.html#type-t">Caqti_query.t</a>)</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'m</span>)</span> <a href="../index.html#type-t">t</a></span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span><a href="../../Caqti_driver_info/index.html#type-dialect_tag">Caqti_driver_info.dialect_tag</a> <span class="arrow">&#45;&gt;</span></span> string)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span class="type-var">'a</span>, <span class="type-var">'b</span>, <span class="type-var">'m</span>)</span> <a href="../index.html#type-t">t</a></span></span></code></div><div class="spec-doc"><p>Applies a dialect-dependent query string which is parsed with <a href="../../Caqti_query/index.html#val-of_string_exn"><code>Caqti_query.of_string_exn</code></a>.</p></div></div></div></body></html>
