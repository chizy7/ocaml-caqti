<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Caqti_query (caqti.Caqti_query)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../odoc.support/odoc.css"/><meta name="generator" content="odoc 2.4.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../odoc.support/highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../index.html">caqti</a> &#x00BB; Caqti_query</nav><header class="odoc-preamble"><h1>Module <code><span>Caqti_query</span></code></h1><p>Intermediate query string representation.</p><p>This module provides a common representation of database query strings. This module can be used directly to construct queries dynamically, or indirectly via the parser, as may be more convenient when the query string is known at compile-time. In the latter case, the input string is typically very similar to the output string. In either case the intermediate representation serve to unify the syntax across database systems and to provide additional functionality.</p><p>When using this module directly, it provides:</p><ul><li>flexible, pure, and efficient construction (<a href="#type-t.S"><code>S</code></a>, <a href="#type-t.L"><code>L</code></a>),</li><li>uniform index-based parameter references (<a href="#type-t.P"><code>P</code></a>),</li><li>expansion of fragments provided by an environment function (<a href="#type-t.E"><code>E</code></a>), and</li><li>safe embedding of values in queries (<a href="#type-t.V"><code>V</code></a>, <a href="#type-t.Q"><code>Q</code></a>).</li></ul></header><nav class="odoc-toc"><ul><li><a href="#construction">Construction</a><ul><li><a href="#embedding-values">Embedding Values</a></li></ul></li><li><a href="#normalization-and-equality">Normalization and Equality</a></li><li><a href="#parsing,-expansion,-and-printing">Parsing, Expansion, and Printing</a></li></ul></nav><div class="odoc-content"><h3 id="construction"><a href="#construction" class="anchor"></a>Construction</h3><div class="odoc-spec"><div class="spec type anchored" id="type-t"><a href="#type-t" class="anchor"></a><code><span><span class="keyword">type</span> t</span><span> = </span></code><ol><li id="type-t.L" class="def variant constructor anchored"><a href="#type-t.L" class="anchor"></a><code><span>| </span><span><span class="constructor">L</span> <span class="keyword">of</span> string</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>L frag</code> translates to the literally inserted substring <code>frag</code>. The <code>frag</code> argument must be trusted or verified to be secure to avoid SQL injection attacks. Use <a href="#type-t.V"><code>V</code></a>, <a href="#type-t.Q"><code>Q</code></a>, or <a href="#type-t.P"><code>P</code></a> to safely insert strings or other values.</p><span class="comment-delim">*)</span></div></li><li id="type-t.V" class="def variant constructor anchored"><a href="#type-t.V" class="anchor"></a><code><span>| </span><span><span class="constructor">V</span> : <span><span class="type-var">'a</span> <a href="../Caqti_type/Field/index.html#type-t">Caqti_type.Field.t</a></span> * <span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span> <a href="#type-t">t</a></span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>V (t, v)</code> translates to a parameter of type <code>t</code> bound to the value <code>v</code>. That is, the query string will contain a parameter reference which does not conflict with any <a href="#type-t.P"><code>P</code></a> nodes and bind <code>v</code> to the corresponding parameter each time the query is executed. This allows taking advantage of driver-dependent serialization and escaping mechanisms to safely send values to the database server.</p><span class="comment-delim">*)</span></div></li><li id="type-t.Q" class="def variant constructor anchored"><a href="#type-t.Q" class="anchor"></a><code><span>| </span><span><span class="constructor">Q</span> <span class="keyword">of</span> string</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>Q s</code> corresponds to a quoted string literal. This is passed as part of the query string if a suitable quoting function is available in the client library, otherwise it is equivalent to <a href="#type-t.V"><code>V</code></a><code>(</code><a href="../Caqti_type/Field/index.html#type-t.String"><code>Caqti_type.Field.t.String</code></a><code>, s)</code>.</p><span class="comment-delim">*)</span></div></li><li id="type-t.P" class="def variant constructor anchored"><a href="#type-t.P" class="anchor"></a><code><span>| </span><span><span class="constructor">P</span> <span class="keyword">of</span> int</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>P i</code> refers to parameter number <code>i</code>, counting from 0, so that e.g. <code>P 0</code> translates to <code>&quot;$1&quot;</code> for PostgreSQL and <code>&quot;?1&quot;</code> for SQLite3.</p><span class="comment-delim">*)</span></div></li><li id="type-t.E" class="def variant constructor anchored"><a href="#type-t.E" class="anchor"></a><code><span>| </span><span><span class="constructor">E</span> <span class="keyword">of</span> string</span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>E name</code> will be replaced by the fragment returned by an environment lookup function, as passed directly to <a href="#val-expand"><code>expand</code></a> or indirectly through the <code>?env</code> argument found in higher-level functions. An error will be issued for any remaining <code>E</code>-nodes in the final translation to a query string.</p><span class="comment-delim">*)</span></div></li><li id="type-t.S" class="def variant constructor anchored"><a href="#type-t.S" class="anchor"></a><code><span>| </span><span><span class="constructor">S</span> <span class="keyword">of</span> <span><a href="#type-t">t</a> list</span></span></code><div class="def-doc"><span class="comment-delim">(*</span><p><code>S frags</code> is the concatenation of <code>frags</code>. Apart from combining different kinds of nodes, this constructor can be nested according to the flow of the generating code.</p><span class="comment-delim">*)</span></div></li></ol></div><div class="spec-doc"><p><code>t</code> is an intermediate representation of a query string to be send to a database, possibly combined with some hidden parameters used to safely embed values. Apart from embedding values, this representation provides indexed parameter references, independent of the target database system. For databases which use linear parameter references (like <code>?</code> for MariaDB), the driver will reshuffle, elide, and duplicate parameters as needed.</p><p>Please note that additional constructors may be added to this type across minor releases.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-concat"><a href="#val-concat" class="anchor"></a><code><span><span class="keyword">val</span> concat : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span><a href="#type-t">t</a> list</span> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>concat sep frags</code> is <code>frags</code> interfixed with <code>sep</code> if <code>frags</code> is non-empty, and the empty string if <code>frags</code> is empty.</p></div></div><h4 id="embedding-values"><a href="#embedding-values" class="anchor"></a>Embedding Values</h4><p>The following are shortcuts for combining <a href="#type-t.V"><code>V</code></a> with some of the field types. The values will be passed as hidden parameters.</p><div class="odoc-spec"><div class="spec value anchored" id="val-bool"><a href="#val-bool" class="anchor"></a><code><span><span class="keyword">val</span> bool : <span>bool <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-int"><a href="#val-int" class="anchor"></a><code><span><span class="keyword">val</span> int : <span>int <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-float"><a href="#val-float" class="anchor"></a><code><span><span class="keyword">val</span> float : <span>float <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-string"><a href="#val-string" class="anchor"></a><code><span><span class="keyword">val</span> string : <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-octets"><a href="#val-octets" class="anchor"></a><code><span><span class="keyword">val</span> octets : <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pdate"><a href="#val-pdate" class="anchor"></a><code><span><span class="keyword">val</span> pdate : <span><span class="xref-unresolved">Ptime</span>.t <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ptime"><a href="#val-ptime" class="anchor"></a><code><span><span class="keyword">val</span> ptime : <span><span class="xref-unresolved">Ptime</span>.t <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ptime_span"><a href="#val-ptime_span" class="anchor"></a><code><span><span class="keyword">val</span> ptime_span : <span><span class="xref-unresolved">Ptime</span>.span <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-const_fields"><a href="#val-const_fields" class="anchor"></a><code><span><span class="keyword">val</span> const_fields : <span><span><span class="type-var">'a</span> <a href="../Caqti_type/index.html#type-t">Caqti_type.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> list</span></span></code></div><div class="spec-doc"><p><code>const_fields t x</code> returns a list of fragments corresponding to the single-field projections of the value <code>x</code> as described by the type descriptor <code>t</code>. Each element of the returned list will be either a <a href="#type-t.V"><code>V</code></a>-fragment containing the projected value, or the <code>L[&quot;NULL&quot;]</code> fragment if the projection is <code>None</code>.</p><p>The result can be turned into a comma-separated list with <a href="#val-concat"><code>concat</code></a>, except values of unitary types, i.e. types having no fields, may require special care.</p></div></div><h3 id="normalization-and-equality"><a href="#normalization-and-equality" class="anchor"></a>Normalization and Equality</h3><div class="odoc-spec"><div class="spec value anchored" id="val-normal"><a href="#val-normal" class="anchor"></a><code><span><span class="keyword">val</span> normal : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>normal q</code> rewrites <code>q</code> to a normal form containing at most one top-level <a href="#type-t.S"><code>S</code></a> constructor, containing no empty literals, and no consecutive literals. This function can be used to post-process queries before using <a href="#val-equal"><code>equal</code></a> and <a href="#val-hash"><code>hash</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-equal"><a href="#val-equal" class="anchor"></a><code><span><span class="keyword">val</span> equal : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> bool</span></code></div><div class="spec-doc"><p>Equality predicate for <a href="#type-t"><code>t</code></a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-hash"><a href="#val-hash" class="anchor"></a><code><span><span class="keyword">val</span> hash : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> int</span></code></div><div class="spec-doc"><p>A hash function compatible with <a href="#val-equal"><code>equal</code></a>. The hash function may change across minor versions and may depend on architecture.</p></div></div><h3 id="parsing,-expansion,-and-printing"><a href="#parsing,-expansion,-and-printing" class="anchor"></a>Parsing, Expansion, and Printing</h3><div class="odoc-spec"><div class="spec value anchored" id="val-pp"><a href="#val-pp" class="anchor"></a><code><span><span class="keyword">val</span> pp : <span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>pp ppf q</code> prints a <em>human</em>-readable representation of <code>q</code> on <code>ppf</code>. The printed string is <em>not suitable for sending to an SQL database</em>; doing so may lead to an SQL injection vulnerability.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-show"><a href="#val-show" class="anchor"></a><code><span><span class="keyword">val</span> show : <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> string</span></code></div><div class="spec-doc"><p><code>show q</code> is the same <em>human</em>-readable representation of <code>q</code> as printed by <a href="#val-pp"><code>pp</code></a>. The returned string is <em>not suitable for sending to an SQL database</em>; doing so may lead to an SQL injection vulnerability.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-expand_error"><a href="#type-expand_error" class="anchor"></a><code><span><span class="keyword">type</span> expand_error</span></code></div><div class="spec-doc"><p>A description of the error caused during <a href="#val-expand"><code>expand</code></a> if the environment lookup function returns an invalid result or raises <code>Not_found</code> for a variable when the expansion is final.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-pp_expand_error"><a href="#val-pp_expand_error" class="anchor"></a><code><span><span class="keyword">val</span> pp_expand_error : <span><span class="xref-unresolved">Stdlib</span>.Format.formatter <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-expand_error">expand_error</a> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Prints an informative error.</p></div></div><div class="odoc-spec"><div class="spec exception anchored" id="exception-Expand_error"><a href="#exception-Expand_error" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Expand_error</span> <span class="keyword">of</span> <a href="#type-expand_error">expand_error</a></span></code></div><div class="spec-doc"><p>The exception raised by <a href="#val-expand"><code>expand</code></a> when there are issues expanding an environment variable using the provided callback.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-expand"><a href="#val-expand" class="anchor"></a><code><span><span class="keyword">val</span> expand : <span><span class="optlabel">?final</span>:bool <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a>)</span> <span class="arrow">&#45;&gt;</span></span> <span><a href="#type-t">t</a> <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p><code>expand f q</code> replaces each occurrence of <code>E v</code> some some <code>v</code> with <code>f v</code> or leaves it unchanged where <code>f v</code> raises <code>Not_found</code>. The <code>Not_found</code> exception will not escape this call.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">final</span> <p>If <code>true</code>, then an error is raised instead of leaving environment references unexpended if <code>f</code> raises <code>Not_found</code>. This is used by drivers for performing the final expansion. Defaults to <code>false</code>.</p></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <a href="#exception-Expand_error"><code>Expand_error</code></a> <p>if <code>~final:true</code> is passed and <code>f</code> raise <code>Not_found</code> or if <code>f</code> returns a query containing environment references.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-angstrom_parser"><a href="#val-angstrom_parser" class="anchor"></a><code><span><span class="keyword">val</span> angstrom_parser : <span><a href="#type-t">t</a> <span class="xref-unresolved">Angstrom</span>.t</span></span></code></div><div class="spec-doc"><p>Matches a single expression terminated by the end of input or a semicolon lookahead. The accepted languages is described in <a href="../query_template.html" title="query_template">The Syntax of Query Templates</a>.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-angstrom_parser_with_semicolon"><a href="#val-angstrom_parser_with_semicolon" class="anchor"></a><code><span><span class="keyword">val</span> angstrom_parser_with_semicolon : <span><a href="#type-t">t</a> <span class="xref-unresolved">Angstrom</span>.t</span></span></code></div><div class="spec-doc"><p>A variant of <code>angstrom_parser</code> which accepts unquoted semicolons as part of the single statement, as is valid in some cases like in SQLite3 trigger definitions. This is the parser used by <a href="../Caqti_request/index.html"><code>Caqti_request</code></a>, where it's assumed that the input is a single SQL statement.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-angstrom_list_parser"><a href="#val-angstrom_list_parser" class="anchor"></a><code><span><span class="keyword">val</span> angstrom_list_parser : <span><span><a href="#type-t">t</a> list</span> <span class="xref-unresolved">Angstrom</span>.t</span></span></code></div><div class="spec-doc"><p>Matches a sequence of statements while ignoring surrounding white space and end-of-line comments starting with <code>&quot;--&quot;</code>. This parser can be used to load schema files with support for environment expansions, like substituting the name of the database schema.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-of_string"><a href="#val-of_string" class="anchor"></a><code><span><span class="keyword">val</span> of_string : <span>string <span class="arrow">&#45;&gt;</span></span> <span><span>(<a href="#type-t">t</a>, <span>[ <span>`Invalid of int * string</span> ]</span>)</span> <span class="xref-unresolved">Stdlib</span>.result</span></span></code></div><div class="spec-doc"><p>Parses a single expression using <a href="#val-angstrom_parser_with_semicolon"><code>angstrom_parser_with_semicolon</code></a>. The error indicates the byte position of the input string where the parse failure occurred in addition to an error message. See <a href="../query_template.html" title="query_template">The Syntax of Query Templates</a> for how the input string is interpreted.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-of_string_exn"><a href="#val-of_string_exn" class="anchor"></a><code><span><span class="keyword">val</span> of_string_exn : <span>string <span class="arrow">&#45;&gt;</span></span> <a href="#type-t">t</a></span></code></div><div class="spec-doc"><p>Like <a href="#val-of_string"><code>of_string</code></a>, but raises an exception on error.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <code>Failure</code> <p>if parsing failed.</p></li></ul></div></div></div></body></html>
